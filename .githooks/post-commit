#!/bin/bash
# Post-commit hook para reportar estadÃ­sticas despuÃ©s de cada commit

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Funciones
log() {
    echo -e "${BLUE}[POST-COMMIT]${NC} $1"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# Obtener informaciÃ³n del commit
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --pretty=format:"%s")
COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
COMMIT_DATE=$(git log -1 --pretty=format:"%ad" --date=short)

# Obtener estadÃ­sticas del commit
ADDED_LINES=$(git show --stat | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
DELETED_LINES=$(git show --stat | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)

# Mostrar informaciÃ³n del commit
echo ""
log "ğŸ“Š Commit Statistics"
echo "  Hash: $COMMIT_HASH"
echo "  Message: $COMMIT_MSG"
echo "  Author: $COMMIT_AUTHOR"
echo "  Date: $COMMIT_DATE"
echo "  Files modified: $MODIFIED_FILES"
echo "  Lines added: $ADDED_LINES"
echo "  Lines deleted: $DELETED_LINES"

# Mostrar archivos modificados
echo ""
log "ğŸ“ Modified Files:"
git diff-tree --no-commit-id --name-only -r HEAD | sed 's/^/  /'

# Mostrar commits recientes
echo ""
log "ğŸ“œ Recent Commits:"
git log --oneline -5

# Verificar si hay archivos sin seguimiento
UNTRACKED_FILES=$(git ls-files --others --exclude-standard | wc -l)
if [ "$UNTRACKED_FILES" -gt 0 ]; then
    echo ""
    log "âš ï¸  Untracked files: $UNTRACKED_FILES"
fi

# Verificar el estado del repositorio
AHEAD_COUNT=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo "0")
BEHIND_COUNT=$(git rev-list --count HEAD..@{u} 2>/dev/null || echo "0")

if [ "$AHEAD_COUNT" -gt 0 ]; then
    echo ""
    log "ğŸš€ Your branch is $AHEAD_COUNT commit(s) ahead of origin"
    echo "  Consider pushing: git push origin $(git branch --show-current)"
fi

if [ "$BEHIND_COUNT" -gt 0 ]; then
    echo ""
    log "â¬‡ï¸  Your branch is $BEHIND_COUNT commit(s) behind origin"
    echo "  Consider pulling: git pull origin $(git branch --show-current)"
fi

echo ""
success "Post-commit hook completed! ğŸ‰"

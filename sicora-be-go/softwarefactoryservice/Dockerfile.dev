# Development Dockerfile for SoftwareFactoryService
FROM golang:1.23-bullseye

# Install essential development tools
RUN apt-get update && apt-get install -y \
    git \
    curl \
    vim \
    zsh \
    postgresql-client \
    redis-tools \
    make \
    build-essential \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Oh My Zsh for better terminal experience
RUN sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" || true

# Install Air for hot reloading
RUN go install github.com/air-verse/air@latest

# Install additional Go tools
RUN go install github.com/swaggo/swag/cmd/swag@latest && \
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest && \
    go install github.com/go-delve/delve/cmd/dlv@latest && \
    go install golang.org/x/tools/cmd/goimports@latest && \
    go install mvdan.cc/gofumpt@latest

# Install Python for migration tools
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Create vscode user for compatibility
RUN groupadd --gid 1000 vscode && \
    useradd --uid 1000 --gid vscode --shell /bin/zsh --create-home vscode && \
    echo "vscode ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Configure Go environment for vscode user
RUN mkdir -p /home/vscode/go && \
    chown -R vscode:vscode /home/vscode/go

ENV GOPATH=/home/vscode/go
ENV PATH=$GOPATH/bin:$PATH

# Copy go.mod and go.sum for dependency caching
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy air configuration
COPY .air.toml .air.toml

# Set ownership
RUN chown -R vscode:vscode /workspace

# Switch to vscode user
USER vscode

# Set default shell
SHELL ["/bin/zsh", "-c"]

# Expose ports
EXPOSE 8080 2345

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# Default command for development
CMD ["air", "-c", ".air.toml"]
